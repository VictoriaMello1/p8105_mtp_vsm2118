---
title: "Data Science Midterm"
author: "Victoria Mello (vsm2118)"
date: "October 23, 2023"
output: github_document
---

```{r setup, include=FALSE}

library(tidyverse)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuious.color = "viridis",
  ggplot2.continuious.fill = "viridis"
  
)

scale_color_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

The raw data used in this analysis consists of Change of Address (COA) data from the US Postal Service for New York City between 2018 and 2022. The COA data includes information on the total number of permanent address changes going into and out of each ZIP code in New York City. The initial section of the report focuses on importing, cleaning, and ensuring data quality. This process results in a clean and structured dataset, ready for analysis. The dataset's characteristics, including observations, unique ZIP codes, and neighborhoods, are described. Data quality issues are also addressed. The subsequent section visualizes the data with an analysis of address change trends, uncovering extreme values, and plots that highlight neighborhood-level insights over the five-year period. The report concludes with an acknowledgment of any limitations of the dataset.

## Section 1 â€“ Data import, cleaning, and quality control

Read in the data:
```{r}
zip_data = read_csv("zip_codes.csv")

sheet_names <- c("2018", "2019", "2020", "2021", "2022")
coa_data <- map_dfr(sheet_names, ~ readxl::read_xlsx("USPS.xlsx", sheet = .x))

view(coa_data)

coa_data = coa_data %>% 
  janitor::clean_names() %>% 
  mutate(
    year = as.integer(str_sub(month, 1, 4)),
    net_change = `total_perm_in` - `total_perm_out`
  )
  
view(coa_data)
```


Cleaning zipcode data and creating a borough variable:
```{r}
# Create a "borough" variable in the ZIP code data
zip_data <- zip_data %>%
  janitor::clean_names() %>% 
  rename(zipcode = zip_code) %>% 
  mutate(
    borough = case_when(
      county_name %in% c("Kings") ~ "Brooklyn",
      county_name %in% c("Queens") ~ "Queens",
      county_name == "Bronx" ~ "Bronx",
      county_name == "New York" ~ "Manhattan",
      county_name == "Richmond" ~ "Staten Island"
    )
  )
view(zip_data)
```


Merging the zipcode and coa data sets:
```{r}
# Merge the COA and ZIP code data based on ZIP code
merged_data <- coa_data %>%
  left_join(zip_data, by = "zipcode")

# Select only the necessary variables for later visualizations
final_data <- merged_data %>%
  select(zipcode, neighborhood, borough, year, month, net_change, city)

view(final_data)
```

The resulting tidy dataset final_data contains a total of `r nrow(final_data)` observations. It includes data from `r n_distinct(final_data$zipcode)` unique ZIP codes and data from `r n_distinct(final_data$neighborhood)` unique neighborhoods.


Comparing most common values of 'city' in Manhattan and Queens boroughs: 
```{r}
# Filter the data for Manhattan and Queens
manhattan_data <- final_data %>%
  filter(borough == "Manhattan")

queens_data <- final_data %>%
  filter(borough == "Queens")

# Create tables for the most common cities in Manhattan and Queens
manhattan_table <- manhattan_data %>%
  count(city, sort = TRUE)

queens_table <- queens_data %>%
  count(city, sort = TRUE)

knitr::kable(manhattan_table, caption = "Manhattan most common city value")
knitr::kable(queens_table, caption = "Queens most common city value")
```

#### Data Quality Issues 
In the Manhattan table, there appears to be variations in city names such as "NEW YORK," "NYC," and "WALL STREET." These variations may hinder accurate analysis and visualization by potentially duplicating or misrepresenting data. Additionally, the presence of "BRONX" and "BROOKLYN" entries within Manhattan suggests data entry errors or misclassification, which could lead to inaccuracies in borough-specific analyses. Based on these observations it seems that the "city" variable is not currently usable as it has both borough and neighborhood information. Instead, for analysis we can use the "neighborhood" variable for more micro-neighborhood level analysis as well as the "borough" variable that was created in the data cleaning step. Both of these levels of analysis into  


Exploring zip code count:
```{r}
# Count the observations for each ZIP code
zip_code_counts <- final_data %>%
  group_by(zipcode, neighborhood, borough, city) %>%
  summarise(Observation_Count = n())

# Filter for ZIP codes with less than 60 observations
zip_count_60 <- zip_code_counts %>%
  filter(Observation_Count < 60) %>%
  arrange(desc(Observation_Count))


view(zip_count_60)
knitr::kable(zip_count_60)
```

As shown in the table above there are 58 zip codes with fewer than 60 observations for change of address. There are a few potential reasons and factors that are likely resulting in these specific zip codes having so few observations. For example many of the zip codes in this tabel that are located in Manhattan are within the lower and midtown neighborhoods, which are areas characterized by numerous business districts and commercial areas. Thus these zip codes may be predominantly associated with business addresses, resulting in a lower frequency of residential address changes. Another observation from this table that could explain a potential reason for these zip codes having less than 60 observations for changes in address is that many of these zip codes are within residential areas where people are more likely to own property and as a result might not be moving in and out of the neighborhood as frequently. In the table there is a high representation of zip codes from Queens and Brooklyn which are boroughs with higher rates of home ownership, pointing to this being a potential factor at play. 


